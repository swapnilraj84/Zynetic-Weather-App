"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _express = require("express");
var _lodash = _interopRequireDefault(require("lodash"));
var _middleware = require("@verdaccio/middleware");
var _tarball = require("@verdaccio/tarball");
var _utils = require("@verdaccio/utils");
var _constants = require("../../../lib/constants");
var _logger = require("../../../lib/logger");
var _utils2 = require("../../../lib/utils");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }
function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }
function _defineProperty(obj, key, value) { key = _toPropertyKey(key); if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }
function _toPropertyKey(arg) { var key = _toPrimitive(arg, "string"); return typeof key === "symbol" ? key : String(key); }
function _toPrimitive(input, hint) { if (typeof input !== "object" || input === null) return input; var prim = input[Symbol.toPrimitive]; if (prim !== undefined) { var res = prim.call(input, hint || "default"); if (typeof res !== "object") return res; throw new TypeError("@@toPrimitive must return a primitive value."); } return (hint === "string" ? String : Number)(input); }
const getOrder = (order = 'asc') => {
  return order === 'asc';
};
function addPackageWebApi(storage, auth, config) {
  const can = (0, _middleware.allow)(auth, {
    beforeAll: (params, message) => {
      _logger.logger.debug(params, message);
    },
    afterAll: (params, message) => _logger.logger.debug(params, message)
  });
  const pkgRouter = (0, _express.Router)(); /* eslint new-cap: 0 */

  const checkAllow = (name, remoteUser) => new Promise((resolve, reject) => {
    try {
      auth.allow_access({
        packageName: name
      }, remoteUser, (err, allowed) => {
        if (err) {
          resolve(false);
        }
        resolve(allowed);
      });
    } catch (err) {
      reject(err);
    }
  });

  // Get list of all visible package
  pkgRouter.get('/packages', function (req, res, next) {
    storage.getLocalDatabase(async function (err, packages) {
      if (err) {
        throw err;
      }
      async function processPackages(packages = []) {
        const permissions = [];
        const packgesCopy = packages.slice();
        for (const pkg of packgesCopy) {
          const pkgCopy = _objectSpread({}, pkg);
          pkgCopy.author = (0, _utils2.formatAuthor)(pkg.author);
          try {
            if (await checkAllow(pkg.name, req.remote_user)) {
              if (config.web) {
                pkgCopy.author.avatar = (0, _utils.generateGravatarUrl)(pkgCopy.author.email, config.web.gravatar);
              }
              if (!_lodash.default.isNil(pkgCopy.dist) && !_lodash.default.isNull(pkgCopy.dist.tarball)) {
                pkgCopy.dist.tarball = (0, _tarball.getLocalRegistryTarballUri)(pkgCopy.dist.tarball, pkg.name, {
                  protocol: req.protocol,
                  headers: req.headers,
                  host: req.hostname
                }, config.url_prefix);
              }
              permissions.push(pkgCopy);
            }
          } catch (err) {
            _logger.logger.error({
              name: pkg.name,
              error: err
            }, 'permission process for @{name} has failed: @{error}');
            throw err;
          }
        }
        return permissions;
      }
      const {
        web
      } = config;
      // @ts-ignore
      const order = config.web ? getOrder(web.sort_packages) : true;
      try {
        next((0, _utils2.sortByName)(await processPackages(packages), order));
      } catch (error) {
        next(_utils2.ErrorCode.getInternalError());
      }
    });
  });

  // Get package readme
  pkgRouter.get('/package/readme/(@:scope/)?:package/:version?', can('access'), function (req, res, next) {
    const packageName = req.params.scope ? (0, _utils2.addScope)(req.params.scope, req.params.package) : req.params.package;
    storage.getPackage({
      name: packageName,
      uplinksLook: true,
      req,
      callback: function (err, info) {
        if (err) {
          return next(err);
        }
        res.set(_constants.HEADER_TYPE.CONTENT_TYPE, _constants.HEADERS.TEXT_PLAIN);
        const referer = req.get('Referer');
        const pathname = referer ? new URL(referer).pathname : undefined;
        next((0, _utils2.parseReadme)(info.name, info.readme));
      }
    });
  });
  pkgRouter.get('/sidebar/(@:scope/)?:package', can('access'), function (req, res, next) {
    const packageName = req.params.scope ? (0, _utils2.addScope)(req.params.scope, req.params.package) : req.params.package;
    storage.getPackage({
      name: packageName,
      uplinksLook: true,
      keepUpLinkData: true,
      req,
      callback: function (err, info) {
        if (_lodash.default.isNil(err)) {
          const {
            v
          } = req.query;
          let sideBarInfo = _lodash.default.clone(info);
          sideBarInfo.versions = (0, _tarball.convertDistRemoteToLocalTarballUrls)(info, {
            protocol: req.protocol,
            headers: req.headers,
            host: req.hostname
          }, config.url_prefix).versions;
          if ((0, _utils2.isVersionValid)(info, v)) {
            // @ts-ignore
            sideBarInfo.latest = sideBarInfo.versions[v];
            sideBarInfo.latest.author = (0, _utils2.formatAuthor)(sideBarInfo.latest.author);
          } else {
            var _sideBarInfo;
            sideBarInfo.latest = sideBarInfo.versions[info[_constants.DIST_TAGS].latest];
            if ((_sideBarInfo = sideBarInfo) !== null && _sideBarInfo !== void 0 && _sideBarInfo.latest) {
              sideBarInfo.latest.author = (0, _utils2.formatAuthor)(sideBarInfo.latest.author);
            } else {
              res.status(_constants.HTTP_STATUS.NOT_FOUND);
              res.end();
              return;
            }
          }
          sideBarInfo = (0, _utils2.deleteProperties)(['readme', '_attachments', '_rev', 'name'], sideBarInfo);
          if (config.web) {
            sideBarInfo = (0, _utils2.addGravatarSupport)(sideBarInfo, config.web.gravatar);
          } else {
            sideBarInfo = (0, _utils2.addGravatarSupport)(sideBarInfo);
          }
          next(sideBarInfo);
        } else {
          res.status(_constants.HTTP_STATUS.NOT_FOUND);
          res.end();
        }
      }
    });
  });
  return pkgRouter;
}
var _default = addPackageWebApi;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJnZXRPcmRlciIsIm9yZGVyIiwiYWRkUGFja2FnZVdlYkFwaSIsInN0b3JhZ2UiLCJhdXRoIiwiY29uZmlnIiwiY2FuIiwiYWxsb3ciLCJiZWZvcmVBbGwiLCJwYXJhbXMiLCJtZXNzYWdlIiwibG9nZ2VyIiwiZGVidWciLCJhZnRlckFsbCIsInBrZ1JvdXRlciIsIlJvdXRlciIsImNoZWNrQWxsb3ciLCJuYW1lIiwicmVtb3RlVXNlciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiYWxsb3dfYWNjZXNzIiwicGFja2FnZU5hbWUiLCJlcnIiLCJhbGxvd2VkIiwiZ2V0IiwicmVxIiwicmVzIiwibmV4dCIsImdldExvY2FsRGF0YWJhc2UiLCJwYWNrYWdlcyIsInByb2Nlc3NQYWNrYWdlcyIsInBlcm1pc3Npb25zIiwicGFja2dlc0NvcHkiLCJzbGljZSIsInBrZyIsInBrZ0NvcHkiLCJhdXRob3IiLCJmb3JtYXRBdXRob3IiLCJyZW1vdGVfdXNlciIsIndlYiIsImF2YXRhciIsImdlbmVyYXRlR3JhdmF0YXJVcmwiLCJlbWFpbCIsImdyYXZhdGFyIiwiXyIsImlzTmlsIiwiZGlzdCIsImlzTnVsbCIsInRhcmJhbGwiLCJnZXRMb2NhbFJlZ2lzdHJ5VGFyYmFsbFVyaSIsInByb3RvY29sIiwiaGVhZGVycyIsImhvc3QiLCJob3N0bmFtZSIsInVybF9wcmVmaXgiLCJwdXNoIiwiZXJyb3IiLCJzb3J0X3BhY2thZ2VzIiwic29ydEJ5TmFtZSIsIkVycm9yQ29kZSIsImdldEludGVybmFsRXJyb3IiLCJzY29wZSIsImFkZFNjb3BlIiwicGFja2FnZSIsImdldFBhY2thZ2UiLCJ1cGxpbmtzTG9vayIsImNhbGxiYWNrIiwiaW5mbyIsInNldCIsIkhFQURFUl9UWVBFIiwiQ09OVEVOVF9UWVBFIiwiSEVBREVSUyIsIlRFWFRfUExBSU4iLCJyZWZlcmVyIiwicGF0aG5hbWUiLCJVUkwiLCJ1bmRlZmluZWQiLCJwYXJzZVJlYWRtZSIsInJlYWRtZSIsImtlZXBVcExpbmtEYXRhIiwidiIsInF1ZXJ5Iiwic2lkZUJhckluZm8iLCJjbG9uZSIsInZlcnNpb25zIiwiY29udmVydERpc3RSZW1vdGVUb0xvY2FsVGFyYmFsbFVybHMiLCJpc1ZlcnNpb25WYWxpZCIsImxhdGVzdCIsIkRJU1RfVEFHUyIsInN0YXR1cyIsIkhUVFBfU1RBVFVTIiwiTk9UX0ZPVU5EIiwiZW5kIiwiZGVsZXRlUHJvcGVydGllcyIsImFkZEdyYXZhdGFyU3VwcG9ydCJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9hcGkvd2ViL2FwaS9wYWNrYWdlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJvdXRlciB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuaW1wb3J0IHsgYWxsb3cgfSBmcm9tICdAdmVyZGFjY2lvL21pZGRsZXdhcmUnO1xuaW1wb3J0IHtcbiAgY29udmVydERpc3RSZW1vdGVUb0xvY2FsVGFyYmFsbFVybHMsXG4gIGdldExvY2FsUmVnaXN0cnlUYXJiYWxsVXJpLFxufSBmcm9tICdAdmVyZGFjY2lvL3RhcmJhbGwnO1xuaW1wb3J0IHsgQ29uZmlnLCBQYWNrYWdlIH0gZnJvbSAnQHZlcmRhY2Npby90eXBlcyc7XG5pbXBvcnQgeyBnZW5lcmF0ZUdyYXZhdGFyVXJsIH0gZnJvbSAnQHZlcmRhY2Npby91dGlscyc7XG5cbmltcG9ydCB7IERJU1RfVEFHUywgSEVBREVSUywgSEVBREVSX1RZUEUsIEhUVFBfU1RBVFVTIH0gZnJvbSAnLi4vLi4vLi4vbGliL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi8uLi8uLi9saWIvbG9nZ2VyJztcbmltcG9ydCB7XG4gIEVycm9yQ29kZSxcbiAgYWRkR3JhdmF0YXJTdXBwb3J0LFxuICBhZGRTY29wZSxcbiAgZGVsZXRlUHJvcGVydGllcyxcbiAgZm9ybWF0QXV0aG9yLFxuICBpc1ZlcnNpb25WYWxpZCxcbiAgcGFyc2VSZWFkbWUsXG4gIHNvcnRCeU5hbWUsXG59IGZyb20gJy4uLy4uLy4uL2xpYi91dGlscyc7XG5pbXBvcnQge1xuICAkTmV4dEZ1bmN0aW9uVmVyLFxuICAkUmVxdWVzdEV4dGVuZCxcbiAgJFJlc3BvbnNlRXh0ZW5kLFxuICAkU2lkZWJhclBhY2thZ2UsXG4gIElBdXRoLFxuICBJU3RvcmFnZUhhbmRsZXIsXG59IGZyb20gJy4uLy4uLy4uL3R5cGVzJztcblxuY29uc3QgZ2V0T3JkZXIgPSAob3JkZXIgPSAnYXNjJykgPT4ge1xuICByZXR1cm4gb3JkZXIgPT09ICdhc2MnO1xufTtcblxuZXhwb3J0IHR5cGUgUGFja2NhZ2VFeHQgPSBQYWNrYWdlICYgeyBhdXRob3I6IGFueTsgZGlzdD86IHsgdGFyYmFsbDogc3RyaW5nIH0gfTtcblxuZnVuY3Rpb24gYWRkUGFja2FnZVdlYkFwaShzdG9yYWdlOiBJU3RvcmFnZUhhbmRsZXIsIGF1dGg6IElBdXRoLCBjb25maWc6IENvbmZpZyk6IFJvdXRlciB7XG4gIGNvbnN0IGNhbiA9IGFsbG93KGF1dGgsIHtcbiAgICBiZWZvcmVBbGw6IChwYXJhbXMsIG1lc3NhZ2UpID0+IHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhwYXJhbXMsIG1lc3NhZ2UpO1xuICAgIH0sXG4gICAgYWZ0ZXJBbGw6IChwYXJhbXMsIG1lc3NhZ2UpID0+IGxvZ2dlci5kZWJ1ZyhwYXJhbXMsIG1lc3NhZ2UpLFxuICB9KTtcbiAgY29uc3QgcGtnUm91dGVyID0gUm91dGVyKCk7IC8qIGVzbGludCBuZXctY2FwOiAwICovXG5cbiAgY29uc3QgY2hlY2tBbGxvdyA9IChuYW1lLCByZW1vdGVVc2VyKTogUHJvbWlzZTxib29sZWFuPiA9PlxuICAgIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpOiB2b2lkID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF1dGguYWxsb3dfYWNjZXNzKHsgcGFja2FnZU5hbWU6IG5hbWUgfSwgcmVtb3RlVXNlciwgKGVyciwgYWxsb3dlZCk6IHZvaWQgPT4ge1xuICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIHJlc29sdmUoZmFsc2UpO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXNvbHZlKGFsbG93ZWQpO1xuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAvLyBHZXQgbGlzdCBvZiBhbGwgdmlzaWJsZSBwYWNrYWdlXG4gIHBrZ1JvdXRlci5nZXQoXG4gICAgJy9wYWNrYWdlcycsXG4gICAgZnVuY3Rpb24gKHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogJFJlc3BvbnNlRXh0ZW5kLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyKTogdm9pZCB7XG4gICAgICBzdG9yYWdlLmdldExvY2FsRGF0YWJhc2UoYXN5bmMgZnVuY3Rpb24gKGVyciwgcGFja2FnZXMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfVxuXG4gICAgICAgIGFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NQYWNrYWdlcyhwYWNrYWdlczogUGFja2NhZ2VFeHRbXSA9IFtdKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgICBjb25zdCBwZXJtaXNzaW9uczogUGFja2NhZ2VFeHRbXSA9IFtdO1xuICAgICAgICAgIGNvbnN0IHBhY2tnZXNDb3B5ID0gcGFja2FnZXMuc2xpY2UoKTtcbiAgICAgICAgICBmb3IgKGNvbnN0IHBrZyBvZiBwYWNrZ2VzQ29weSkge1xuICAgICAgICAgICAgY29uc3QgcGtnQ29weSA9IHsgLi4ucGtnIH07XG4gICAgICAgICAgICBwa2dDb3B5LmF1dGhvciA9IGZvcm1hdEF1dGhvcihwa2cuYXV0aG9yKTtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIGlmIChhd2FpdCBjaGVja0FsbG93KHBrZy5uYW1lLCByZXEucmVtb3RlX3VzZXIpKSB7XG4gICAgICAgICAgICAgICAgaWYgKGNvbmZpZy53ZWIpIHtcbiAgICAgICAgICAgICAgICAgIHBrZ0NvcHkuYXV0aG9yLmF2YXRhciA9IGdlbmVyYXRlR3JhdmF0YXJVcmwoXG4gICAgICAgICAgICAgICAgICAgIHBrZ0NvcHkuYXV0aG9yLmVtYWlsLFxuICAgICAgICAgICAgICAgICAgICBjb25maWcud2ViLmdyYXZhdGFyXG4gICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIV8uaXNOaWwocGtnQ29weS5kaXN0KSAmJiAhXy5pc051bGwocGtnQ29weS5kaXN0LnRhcmJhbGwpKSB7XG4gICAgICAgICAgICAgICAgICBwa2dDb3B5LmRpc3QudGFyYmFsbCA9IGdldExvY2FsUmVnaXN0cnlUYXJiYWxsVXJpKFxuICAgICAgICAgICAgICAgICAgICBwa2dDb3B5LmRpc3QudGFyYmFsbCxcbiAgICAgICAgICAgICAgICAgICAgcGtnLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHsgcHJvdG9jb2w6IHJlcS5wcm90b2NvbCwgaGVhZGVyczogcmVxLmhlYWRlcnMgYXMgYW55LCBob3N0OiByZXEuaG9zdG5hbWUgfSxcbiAgICAgICAgICAgICAgICAgICAgY29uZmlnLnVybF9wcmVmaXhcbiAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHBlcm1pc3Npb25zLnB1c2gocGtnQ29weSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoXG4gICAgICAgICAgICAgICAgeyBuYW1lOiBwa2cubmFtZSwgZXJyb3I6IGVyciB9LFxuICAgICAgICAgICAgICAgICdwZXJtaXNzaW9uIHByb2Nlc3MgZm9yIEB7bmFtZX0gaGFzIGZhaWxlZDogQHtlcnJvcn0nXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gcGVybWlzc2lvbnM7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB7IHdlYiB9ID0gY29uZmlnO1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGNvbnN0IG9yZGVyOiBib29sZWFuID0gY29uZmlnLndlYiA/IGdldE9yZGVyKHdlYi5zb3J0X3BhY2thZ2VzKSA6IHRydWU7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBuZXh0KHNvcnRCeU5hbWUoYXdhaXQgcHJvY2Vzc1BhY2thZ2VzKHBhY2thZ2VzKSwgb3JkZXIpKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICBuZXh0KEVycm9yQ29kZS5nZXRJbnRlcm5hbEVycm9yKCkpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICk7XG5cbiAgLy8gR2V0IHBhY2thZ2UgcmVhZG1lXG4gIHBrZ1JvdXRlci5nZXQoXG4gICAgJy9wYWNrYWdlL3JlYWRtZS8oQDpzY29wZS8pPzpwYWNrYWdlLzp2ZXJzaW9uPycsXG4gICAgY2FuKCdhY2Nlc3MnKSxcbiAgICBmdW5jdGlvbiAocmVxOiAkUmVxdWVzdEV4dGVuZCwgcmVzOiAkUmVzcG9uc2VFeHRlbmQsIG5leHQ6ICROZXh0RnVuY3Rpb25WZXIpOiB2b2lkIHtcbiAgICAgIGNvbnN0IHBhY2thZ2VOYW1lID0gcmVxLnBhcmFtcy5zY29wZVxuICAgICAgICA/IGFkZFNjb3BlKHJlcS5wYXJhbXMuc2NvcGUsIHJlcS5wYXJhbXMucGFja2FnZSlcbiAgICAgICAgOiByZXEucGFyYW1zLnBhY2thZ2U7XG5cbiAgICAgIHN0b3JhZ2UuZ2V0UGFja2FnZSh7XG4gICAgICAgIG5hbWU6IHBhY2thZ2VOYW1lLFxuICAgICAgICB1cGxpbmtzTG9vazogdHJ1ZSxcbiAgICAgICAgcmVxLFxuICAgICAgICBjYWxsYmFjazogZnVuY3Rpb24gKGVyciwgaW5mbyk6IHZvaWQge1xuICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXh0KGVycik7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmVzLnNldChIRUFERVJfVFlQRS5DT05URU5UX1RZUEUsIEhFQURFUlMuVEVYVF9QTEFJTik7XG4gICAgICAgICAgY29uc3QgcmVmZXJlciA9IHJlcS5nZXQoJ1JlZmVyZXInKTtcbiAgICAgICAgICBjb25zdCBwYXRobmFtZSA9IHJlZmVyZXIgPyBuZXcgVVJMKHJlZmVyZXIpLnBhdGhuYW1lIDogdW5kZWZpbmVkO1xuICAgICAgICAgIG5leHQocGFyc2VSZWFkbWUoaW5mby5uYW1lLCBpbmZvLnJlYWRtZSkpO1xuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfVxuICApO1xuXG4gIHBrZ1JvdXRlci5nZXQoXG4gICAgJy9zaWRlYmFyLyhAOnNjb3BlLyk/OnBhY2thZ2UnLFxuICAgIGNhbignYWNjZXNzJyksXG4gICAgZnVuY3Rpb24gKHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogJFJlc3BvbnNlRXh0ZW5kLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyKTogdm9pZCB7XG4gICAgICBjb25zdCBwYWNrYWdlTmFtZTogc3RyaW5nID0gcmVxLnBhcmFtcy5zY29wZVxuICAgICAgICA/IGFkZFNjb3BlKHJlcS5wYXJhbXMuc2NvcGUsIHJlcS5wYXJhbXMucGFja2FnZSlcbiAgICAgICAgOiByZXEucGFyYW1zLnBhY2thZ2U7XG5cbiAgICAgIHN0b3JhZ2UuZ2V0UGFja2FnZSh7XG4gICAgICAgIG5hbWU6IHBhY2thZ2VOYW1lLFxuICAgICAgICB1cGxpbmtzTG9vazogdHJ1ZSxcbiAgICAgICAga2VlcFVwTGlua0RhdGE6IHRydWUsXG4gICAgICAgIHJlcSxcbiAgICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uIChlcnI6IEVycm9yLCBpbmZvOiAkU2lkZWJhclBhY2thZ2UpOiB2b2lkIHtcbiAgICAgICAgICBpZiAoXy5pc05pbChlcnIpKSB7XG4gICAgICAgICAgICBjb25zdCB7IHYgfSA9IHJlcS5xdWVyeTtcbiAgICAgICAgICAgIGxldCBzaWRlQmFySW5mbzogYW55ID0gXy5jbG9uZShpbmZvKTtcbiAgICAgICAgICAgIHNpZGVCYXJJbmZvLnZlcnNpb25zID0gY29udmVydERpc3RSZW1vdGVUb0xvY2FsVGFyYmFsbFVybHMoXG4gICAgICAgICAgICAgIGluZm8sXG4gICAgICAgICAgICAgIHsgcHJvdG9jb2w6IHJlcS5wcm90b2NvbCwgaGVhZGVyczogcmVxLmhlYWRlcnMgYXMgYW55LCBob3N0OiByZXEuaG9zdG5hbWUgfSxcbiAgICAgICAgICAgICAgY29uZmlnLnVybF9wcmVmaXhcbiAgICAgICAgICAgICkudmVyc2lvbnM7XG4gICAgICAgICAgICBpZiAoaXNWZXJzaW9uVmFsaWQoaW5mbywgdikpIHtcbiAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICBzaWRlQmFySW5mby5sYXRlc3QgPSBzaWRlQmFySW5mby52ZXJzaW9uc1t2XTtcbiAgICAgICAgICAgICAgc2lkZUJhckluZm8ubGF0ZXN0LmF1dGhvciA9IGZvcm1hdEF1dGhvcihzaWRlQmFySW5mby5sYXRlc3QuYXV0aG9yKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHNpZGVCYXJJbmZvLmxhdGVzdCA9IHNpZGVCYXJJbmZvLnZlcnNpb25zW2luZm9bRElTVF9UQUdTXS5sYXRlc3RdO1xuICAgICAgICAgICAgICBpZiAoc2lkZUJhckluZm8/LmxhdGVzdCkge1xuICAgICAgICAgICAgICAgIHNpZGVCYXJJbmZvLmxhdGVzdC5hdXRob3IgPSBmb3JtYXRBdXRob3Ioc2lkZUJhckluZm8ubGF0ZXN0LmF1dGhvcik7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzLnN0YXR1cyhIVFRQX1NUQVRVUy5OT1RfRk9VTkQpO1xuICAgICAgICAgICAgICAgIHJlcy5lbmQoKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHNpZGVCYXJJbmZvID0gZGVsZXRlUHJvcGVydGllcyhbJ3JlYWRtZScsICdfYXR0YWNobWVudHMnLCAnX3JldicsICduYW1lJ10sIHNpZGVCYXJJbmZvKTtcbiAgICAgICAgICAgIGlmIChjb25maWcud2ViKSB7XG4gICAgICAgICAgICAgIHNpZGVCYXJJbmZvID0gYWRkR3JhdmF0YXJTdXBwb3J0KHNpZGVCYXJJbmZvLCBjb25maWcud2ViLmdyYXZhdGFyKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHNpZGVCYXJJbmZvID0gYWRkR3JhdmF0YXJTdXBwb3J0KHNpZGVCYXJJbmZvKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG5leHQoc2lkZUJhckluZm8pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLk5PVF9GT1VORCk7XG4gICAgICAgICAgICByZXMuZW5kKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfVxuICApO1xuXG4gIHJldHVybiBwa2dSb3V0ZXI7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGFkZFBhY2thZ2VXZWJBcGk7XG4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBO0FBQ0E7QUFFQTtBQUNBO0FBS0E7QUFFQTtBQUNBO0FBQ0E7QUFTNEI7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBVTVCLE1BQU1BLFFBQVEsR0FBRyxDQUFDQyxLQUFLLEdBQUcsS0FBSyxLQUFLO0VBQ2xDLE9BQU9BLEtBQUssS0FBSyxLQUFLO0FBQ3hCLENBQUM7QUFJRCxTQUFTQyxnQkFBZ0IsQ0FBQ0MsT0FBd0IsRUFBRUMsSUFBVyxFQUFFQyxNQUFjLEVBQVU7RUFDdkYsTUFBTUMsR0FBRyxHQUFHLElBQUFDLGlCQUFLLEVBQUNILElBQUksRUFBRTtJQUN0QkksU0FBUyxFQUFFLENBQUNDLE1BQU0sRUFBRUMsT0FBTyxLQUFLO01BQzlCQyxjQUFNLENBQUND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