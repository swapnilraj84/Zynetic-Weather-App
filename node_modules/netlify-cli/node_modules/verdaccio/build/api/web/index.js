"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
exports.loadTheme = loadTheme;
var _debug = _interopRequireDefault(require("debug"));
var _express = _interopRequireDefault(require("express"));
var _lodash = _interopRequireDefault(require("lodash"));
var _middleware = require("@verdaccio/middleware");
var _pluginLoader = _interopRequireDefault(require("../../lib/plugin-loader"));
var _search = _interopRequireDefault(require("../../lib/search"));
var _api = _interopRequireDefault(require("./api"));
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
const debug = (0, _debug.default)('verdaccio:web');
function loadTheme(config) {
  if (_lodash.default.isNil(config.theme) === false) {
    return _lodash.default.head((0, _pluginLoader.default)(config, config.theme, {}, function (plugin) {
      return plugin.staticPath && plugin.manifest && plugin.manifestFiles;
    }, 'verdaccio-theme'));
  }
}
var _default = (config, auth, storage) => {
  const pluginOptions = loadTheme(config) || require('@verdaccio/ui-theme')();
  _search.default.configureStorage(storage);
  // eslint-disable-next-line new-cap
  const router = _express.default.Router();
  // load application
  router.use((0, _middleware.webMiddleware)(config, {
    tokenMiddleware: auth.webUIJWTmiddleware(),
    webEndpointsApi: (0, _api.default)(auth, storage, config)
  }, pluginOptions));
  return router;
};
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJkZWJ1ZyIsImJ1aWxkRGVidWciLCJsb2FkVGhlbWUiLCJjb25maWciLCJfIiwiaXNOaWwiLCJ0aGVtZSIsImhlYWQiLCJsb2FkUGx1Z2luIiwicGx1Z2luIiwic3RhdGljUGF0aCIsIm1hbmlmZXN0IiwibWFuaWZlc3RGaWxlcyIsImF1dGgiLCJzdG9yYWdlIiwicGx1Z2luT3B0aW9ucyIsInJlcXVpcmUiLCJTZWFyY2giLCJjb25maWd1cmVTdG9yYWdlIiwicm91dGVyIiwiZXhwcmVzcyIsIlJvdXRlciIsInVzZSIsIndlYk1pZGRsZXdhcmUiLCJ0b2tlbk1pZGRsZXdhcmUiLCJ3ZWJVSUpXVG1pZGRsZXdhcmUiLCJ3ZWJFbmRwb2ludHNBcGkiLCJ3ZWJBcGkiXSwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYXBpL3dlYi9pbmRleC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYnVpbGREZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5cbmltcG9ydCB7IHdlYk1pZGRsZXdhcmUgfSBmcm9tICdAdmVyZGFjY2lvL21pZGRsZXdhcmUnO1xuXG5pbXBvcnQgbG9hZFBsdWdpbiBmcm9tICcuLi8uLi9saWIvcGx1Z2luLWxvYWRlcic7XG5pbXBvcnQgU2VhcmNoIGZyb20gJy4uLy4uL2xpYi9zZWFyY2gnO1xuaW1wb3J0IHdlYkFwaSBmcm9tICcuL2FwaSc7XG5cbmNvbnN0IGRlYnVnID0gYnVpbGREZWJ1ZygndmVyZGFjY2lvOndlYicpO1xuXG5leHBvcnQgZnVuY3Rpb24gbG9hZFRoZW1lKGNvbmZpZykge1xuICBpZiAoXy5pc05pbChjb25maWcudGhlbWUpID09PSBmYWxzZSkge1xuICAgIHJldHVybiBfLmhlYWQoXG4gICAgICBsb2FkUGx1Z2luKFxuICAgICAgICBjb25maWcsXG4gICAgICAgIGNvbmZpZy50aGVtZSxcbiAgICAgICAge30sXG4gICAgICAgIGZ1bmN0aW9uIChwbHVnaW4pIHtcbiAgICAgICAgICByZXR1cm4gcGx1Z2luLnN0YXRpY1BhdGggJiYgcGx1Z2luLm1hbmlmZXN0ICYmIHBsdWdpbi5tYW5pZmVzdEZpbGVzO1xuICAgICAgICB9LFxuICAgICAgICAndmVyZGFjY2lvLXRoZW1lJ1xuICAgICAgKVxuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgKGNvbmZpZywgYXV0aCwgc3RvcmFnZSkgPT4ge1xuICBjb25zdCBwbHVnaW5PcHRpb25zID0gbG9hZFRoZW1lKGNvbmZpZykgfHwgcmVxdWlyZSgnQHZlcmRhY2Npby91aS10aGVtZScpKCk7XG4gIFNlYXJjaC5jb25maWd1cmVTdG9yYWdlKHN0b3JhZ2UpO1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbmV3LWNhcFxuICBjb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xuICAvLyBsb2FkIGFwcGxpY2F0aW9uXG4gIHJvdXRlci51c2UoXG4gICAgd2ViTWlkZGxld2FyZShcbiAgICAgIGNvbmZpZyxcbiAgICAgIHtcbiAgICAgICAgdG9rZW5NaWRkbGV3YXJlOiBhdXRoLndlYlVJSldUbWlkZGxld2FyZSgpLFxuICAgICAgICB3ZWJFbmRwb2ludHNBcGk6IHdlYkFwaShhdXRoLCBzdG9yYWdlLCBjb25maWcpLFxuICAgICAgfSxcbiAgICAgIHBsdWdpbk9wdGlvbnNcbiAgICApXG4gICk7XG4gIHJldHVybiByb3V0ZXI7XG59O1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBRUE7QUFFQTtBQUNBO0FBQ0E7QUFBMkI7QUFFM0IsTUFBTUEsS0FBSyxHQUFHLElBQUFDLGNBQVUsRUFBQyxlQUFlLENBQUM7QUFFbEMsU0FBU0MsU0FBUyxDQUFDQyxNQUFNLEVBQUU7RUFDaEMsSUFBSUMsZUFBQyxDQUFDQyxLQUFLLENBQUNGLE1BQU0sQ0FBQ0csS0FBSyxDQUFDLEtBQUssS0FBSyxFQUFFO0lBQ25DLE9BQU9GLGVBQUMsQ0FBQ0csSUFBSSxDQUNYLElBQUFDLHFCQUFVLEVBQ1JMLE1BQU0sRUFDTkEsTUFBTSxDQUFDRyxLQUFLLEVBQ1osQ0FBQyxDQUFDLEVBQ0YsVUFBVUcsTUFBTSxFQUFFO01BQ2hCLE9BQU9BLE1BQU0sQ0FBQ0MsVUFBVSxJQUFJRCxNQUFNLENBQUNFLFFBQVEsSUFBSUYsTUFBTSxDQUFDRyxhQUFhO0lBQ3JFLENBQUMsRUFDRCxpQkFBaUIsQ0FDbEIsQ0FDRjtFQUNIO0FBQ0Y7QUFBQyxlQUVjLENBQUNULE1BQU0sRUFBRVUsSUFBSSxFQUFFQyxPQUFPLEtBQUs7RUFDeEMsTUFBTUMsYUFBYSxHQUFHYixTQUFTLENBQUNDLE1BQU0sQ0FBQyxJQUFJYSxPQUFPLENBQUMscUJBQXFCLENBQUMsRUFBRTtFQUMzRUMsZUFBTSxDQUFDQyxnQkFBZ0IsQ0FBQ0osT0FBTyxDQUFDO0VBQ2hDO0VBQ0EsTUFBTUssTUFBTSxHQUFHQyxnQkFBTyxDQUFDQyxNQUFNLEVBQUU7RUFDL0I7RUFDQUYsTUFBTSxDQUFDRyxHQUFHLENBQ1IsSUFBQUMseUJBQWEsRUFDWHBCLE1BQU0sRUFDTjtJQUNFcUIsZUFBZSxFQUFFWCxJQUFJLENBQUNZLGtCQUFrQixFQUFFO0lBQzFDQyxlQUFlLEVBQUUsSUFBQUMsWUFBTSxFQUFDZCxJQUFJLEVBQUVDLE9BQU8sRUFBRVgsTUFBTTtFQUMvQyxDQUFDLEVBQ0RZLGFBQWEsQ0FDZCxDQUNGO0VBQ0QsT0FBT0ksTUFBTTtBQUNmLENBQUM7QUFBQSJ9