"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;
var _express = require("express");
var _lodash = _interopRequireDefault(require("lodash"));
var _middleware = require("@verdaccio/middleware");
var _authUtils = require("../../../../lib/auth-utils");
var _constants = require("../../../../lib/constants");
var _utils = require("../../../../lib/utils");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
function _default(auth, config) {
  const profileRoute = (0, _express.Router)(); /* eslint new-cap: 0 */
  function buildProfile(name) {
    return {
      tfa: false,
      name,
      email: '',
      email_verified: false,
      created: '',
      updated: '',
      cidr_whitelist: null,
      fullname: ''
    };
  }
  profileRoute.get('/user', (0, _middleware.rateLimit)(config === null || config === void 0 ? void 0 : config.userRateLimit), function (req, res, next) {
    if (_lodash.default.isNil(req.remote_user.name) === false) {
      return next(buildProfile(req.remote_user.name));
    }
    res.status(_constants.HTTP_STATUS.UNAUTHORIZED);
    return next({
      message: _constants.API_ERROR.MUST_BE_LOGGED
    });
  });
  profileRoute.post('/user', (0, _middleware.rateLimit)(config === null || config === void 0 ? void 0 : config.userRateLimit), function (req, res, next) {
    if (_lodash.default.isNil(req.remote_user.name)) {
      res.status(_constants.HTTP_STATUS.UNAUTHORIZED);
      return next({
        message: _constants.API_ERROR.MUST_BE_LOGGED
      });
    }
    const {
      password,
      tfa
    } = req.body;
    const {
      name
    } = req.remote_user;
    if (_lodash.default.isNil(password) === false) {
      if ((0, _authUtils.validatePassword)(password.new) === false) {
        /* eslint new-cap:off */
        return next(_utils.ErrorCode.getCode(_constants.HTTP_STATUS.UNAUTHORIZED, _constants.API_ERROR.PASSWORD_SHORT));
        /* eslint new-cap:off */
      }

      auth.changePassword(name, password.old, password.new, (err, isUpdated) => {
        if (_lodash.default.isNull(err) === false) {
          return next(_utils.ErrorCode.getCode(err.status, err.message) || _utils.ErrorCode.getConflict(err.message));
        }
        if (isUpdated) {
          return next(buildProfile(req.remote_user.name));
        }
        return next(_utils.ErrorCode.getInternalError(_constants.API_ERROR.INTERNAL_SERVER_ERROR));
      });
    } else if (_lodash.default.isNil(tfa) === false) {
      return next(_utils.ErrorCode.getCode(_constants.HTTP_STATUS.SERVICE_UNAVAILABLE, _constants.SUPPORT_ERRORS.TFA_DISABLED));
    } else {
      return next(_utils.ErrorCode.getCode(_constants.HTTP_STATUS.INTERNAL_ERROR, _constants.APP_ERROR.PROFILE_ERROR));
    }
  });
  return profileRoute;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJhdXRoIiwiY29uZmlnIiwicHJvZmlsZVJvdXRlIiwiUm91dGVyIiwiYnVpbGRQcm9maWxlIiwibmFtZSIsInRmYSIsImVtYWlsIiwiZW1haWxfdmVyaWZpZWQiLCJjcmVhdGVkIiwidXBkYXRlZCIsImNpZHJfd2hpdGVsaXN0IiwiZnVsbG5hbWUiLCJnZXQiLCJyYXRlTGltaXQiLCJ1c2VyUmF0ZUxpbWl0IiwicmVxIiwicmVzIiwibmV4dCIsIl8iLCJpc05pbCIsInJlbW90ZV91c2VyIiwic3RhdHVzIiwiSFRUUF9TVEFUVVMiLCJVTkFVVEhPUklaRUQiLCJtZXNzYWdlIiwiQVBJX0VSUk9SIiwiTVVTVF9CRV9MT0dHRUQiLCJwb3N0IiwicGFzc3dvcmQiLCJib2R5IiwidmFsaWRhdGVQYXNzd29yZCIsIm5ldyIsIkVycm9yQ29kZSIsImdldENvZGUiLCJQQVNTV09SRF9TSE9SVCIsImNoYW5nZVBhc3N3b3JkIiwib2xkIiwiZXJyIiwiaXNVcGRhdGVkIiwiaXNOdWxsIiwiZ2V0Q29uZmxpY3QiLCJnZXRJbnRlcm5hbEVycm9yIiwiSU5URVJOQUxfU0VSVkVSX0VSUk9SIiwiU0VSVklDRV9VTkFWQUlMQUJMRSIsIlNVUFBPUlRfRVJST1JTIiwiVEZBX0RJU0FCTEVEIiwiSU5URVJOQUxfRVJST1IiLCJBUFBfRVJST1IiLCJQUk9GSUxFX0VSUk9SIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2FwaS9lbmRwb2ludC9hcGkvdjEvcHJvZmlsZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXNwb25zZSwgUm91dGVyIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuXG5pbXBvcnQgeyByYXRlTGltaXQgfSBmcm9tICdAdmVyZGFjY2lvL21pZGRsZXdhcmUnO1xuXG5pbXBvcnQgeyB2YWxpZGF0ZVBhc3N3b3JkIH0gZnJvbSAnLi4vLi4vLi4vLi4vbGliL2F1dGgtdXRpbHMnO1xuaW1wb3J0IHsgQVBJX0VSUk9SLCBBUFBfRVJST1IsIEhUVFBfU1RBVFVTLCBTVVBQT1JUX0VSUk9SUyB9IGZyb20gJy4uLy4uLy4uLy4uL2xpYi9jb25zdGFudHMnO1xuaW1wb3J0IHsgRXJyb3JDb2RlIH0gZnJvbSAnLi4vLi4vLi4vLi4vbGliL3V0aWxzJztcbmltcG9ydCB7ICROZXh0RnVuY3Rpb25WZXIsICRSZXF1ZXN0RXh0ZW5kLCBJQXV0aCB9IGZyb20gJy4uLy4uLy4uLy4uL3R5cGVzJztcblxuZXhwb3J0IGludGVyZmFjZSBQcm9maWxlIHtcbiAgdGZhOiBib29sZWFuO1xuICBuYW1lOiBzdHJpbmc7XG4gIGVtYWlsOiBzdHJpbmc7XG4gIGVtYWlsX3ZlcmlmaWVkOiBib29sZWFuO1xuICBjcmVhdGVkOiBzdHJpbmc7XG4gIHVwZGF0ZWQ6IHN0cmluZztcbiAgY2lkcl93aGl0ZWxpc3Q6IHN0cmluZ1tdIHwgbnVsbDtcbiAgZnVsbG5hbWU6IHN0cmluZztcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gKGF1dGg6IElBdXRoLCBjb25maWcpOiBSb3V0ZXIge1xuICBjb25zdCBwcm9maWxlUm91dGUgPSBSb3V0ZXIoKTsgLyogZXNsaW50IG5ldy1jYXA6IDAgKi9cbiAgZnVuY3Rpb24gYnVpbGRQcm9maWxlKG5hbWU6IHN0cmluZyk6IFByb2ZpbGUge1xuICAgIHJldHVybiB7XG4gICAgICB0ZmE6IGZhbHNlLFxuICAgICAgbmFtZSxcbiAgICAgIGVtYWlsOiAnJyxcbiAgICAgIGVtYWlsX3ZlcmlmaWVkOiBmYWxzZSxcbiAgICAgIGNyZWF0ZWQ6ICcnLFxuICAgICAgdXBkYXRlZDogJycsXG4gICAgICBjaWRyX3doaXRlbGlzdDogbnVsbCxcbiAgICAgIGZ1bGxuYW1lOiAnJyxcbiAgICB9O1xuICB9XG5cbiAgcHJvZmlsZVJvdXRlLmdldChcbiAgICAnL3VzZXInLFxuICAgIHJhdGVMaW1pdChjb25maWc/LnVzZXJSYXRlTGltaXQpLFxuICAgIGZ1bmN0aW9uIChyZXE6ICRSZXF1ZXN0RXh0ZW5kLCByZXM6IFJlc3BvbnNlLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyKTogdm9pZCB7XG4gICAgICBpZiAoXy5pc05pbChyZXEucmVtb3RlX3VzZXIubmFtZSkgPT09IGZhbHNlKSB7XG4gICAgICAgIHJldHVybiBuZXh0KGJ1aWxkUHJvZmlsZShyZXEucmVtb3RlX3VzZXIubmFtZSkpO1xuICAgICAgfVxuXG4gICAgICByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLlVOQVVUSE9SSVpFRCk7XG4gICAgICByZXR1cm4gbmV4dCh7XG4gICAgICAgIG1lc3NhZ2U6IEFQSV9FUlJPUi5NVVNUX0JFX0xPR0dFRCxcbiAgICAgIH0pO1xuICAgIH1cbiAgKTtcblxuICBwcm9maWxlUm91dGUucG9zdChcbiAgICAnL3VzZXInLFxuICAgIHJhdGVMaW1pdChjb25maWc/LnVzZXJSYXRlTGltaXQpLFxuICAgIGZ1bmN0aW9uIChyZXE6ICRSZXF1ZXN0RXh0ZW5kLCByZXM6IFJlc3BvbnNlLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyKTogdm9pZCB7XG4gICAgICBpZiAoXy5pc05pbChyZXEucmVtb3RlX3VzZXIubmFtZSkpIHtcbiAgICAgICAgcmVzLnN0YXR1cyhIVFRQX1NUQVRVUy5VTkFVVEhPUklaRUQpO1xuICAgICAgICByZXR1cm4gbmV4dCh7XG4gICAgICAgICAgbWVzc2FnZTogQVBJX0VSUk9SLk1VU1RfQkVfTE9HR0VELFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgeyBwYXNzd29yZCwgdGZhIH0gPSByZXEuYm9keTtcbiAgICAgIGNvbnN0IHsgbmFtZSB9ID0gcmVxLnJlbW90ZV91c2VyO1xuXG4gICAgICBpZiAoXy5pc05pbChwYXNzd29yZCkgPT09IGZhbHNlKSB7XG4gICAgICAgIGlmICh2YWxpZGF0ZVBhc3N3b3JkKHBhc3N3b3JkLm5ldykgPT09IGZhbHNlKSB7XG4gICAgICAgICAgLyogZXNsaW50IG5ldy1jYXA6b2ZmICovXG4gICAgICAgICAgcmV0dXJuIG5leHQoRXJyb3JDb2RlLmdldENvZGUoSFRUUF9TVEFUVVMuVU5BVVRIT1JJWkVELCBBUElfRVJST1IuUEFTU1dPUkRfU0hPUlQpKTtcbiAgICAgICAgICAvKiBlc2xpbnQgbmV3LWNhcDpvZmYgKi9cbiAgICAgICAgfVxuXG4gICAgICAgIGF1dGguY2hhbmdlUGFzc3dvcmQoXG4gICAgICAgICAgbmFtZSxcbiAgICAgICAgICBwYXNzd29yZC5vbGQsXG4gICAgICAgICAgcGFzc3dvcmQubmV3LFxuICAgICAgICAgIChlcnIsIGlzVXBkYXRlZCk6ICROZXh0RnVuY3Rpb25WZXIgPT4ge1xuICAgICAgICAgICAgaWYgKF8uaXNOdWxsKGVycikgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgIHJldHVybiBuZXh0KFxuICAgICAgICAgICAgICAgIEVycm9yQ29kZS5nZXRDb2RlKGVyci5zdGF0dXMsIGVyci5tZXNzYWdlKSB8fCBFcnJvckNvZGUuZ2V0Q29uZmxpY3QoZXJyLm1lc3NhZ2UpXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChpc1VwZGF0ZWQpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIG5leHQoYnVpbGRQcm9maWxlKHJlcS5yZW1vdGVfdXNlci5uYW1lKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbmV4dChFcnJvckNvZGUuZ2V0SW50ZXJuYWxFcnJvcihBUElfRVJST1IuSU5URVJOQUxfU0VSVkVSX0VSUk9SKSk7XG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfSBlbHNlIGlmIChfLmlzTmlsKHRmYSkgPT09IGZhbHNlKSB7XG4gICAgICAgIHJldHVybiBuZXh0KFxuICAgICAgICAgIEVycm9yQ29kZS5nZXRDb2RlKEhUVFBfU1RBVFVTLlNFUlZJQ0VfVU5BVkFJTEFCTEUsIFNVUFBPUlRfRVJST1JTLlRGQV9ESVNBQkxFRClcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBuZXh0KEVycm9yQ29kZS5nZXRDb2RlKEhUVFBfU1RBVFVTLklOVEVSTkFMX0VSUk9SLCBBUFBfRVJST1IuUFJPRklMRV9FUlJPUikpO1xuICAgICAgfVxuICAgIH1cbiAgKTtcblxuICByZXR1cm4gcHJvZmlsZVJvdXRlO1xufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTtBQUNBO0FBRUE7QUFFQTtBQUNBO0FBQ0E7QUFBa0Q7QUFjbkMsa0JBQVVBLElBQVcsRUFBRUMsTUFBTSxFQUFVO0VBQ3BELE1BQU1DLFlBQVksR0FBRyxJQUFBQyxlQUFNLEdBQUUsQ0FBQyxDQUFDO0VBQy9CLFNBQVNDLFlBQVksQ0FBQ0MsSUFBWSxFQUFXO0lBQzNDLE9BQU87TUFDTEMsR0FBRyxFQUFFLEtBQUs7TUFDVkQsSUFBSTtNQUNKRSxLQUFLLEVBQUUsRUFBRTtNQUNUQyxjQUFjLEVBQUUsS0FBSztNQUNyQkMsT0FBTyxFQUFFLEVBQUU7TUFDWEMsT0FBTyxFQUFFLEVBQUU7TUFDWEMsY0FBYyxFQUFFLElBQUk7TUFDcEJDLFFBQVEsRUFBRTtJQUNaLENBQUM7RUFDSDtFQUVBVixZQUFZLENBQUNXLEdBQUcsQ0FDZCxPQUFPLEVBQ1AsSUFBQUMscUJBQVMsRUFBQ2IsTUFBTSxhQUFOQSxNQUFNLHVCQUFOQSxNQUFNLENBQUVjLGFBQWEsQ0FBQyxFQUNoQyxVQUFVQyxHQUFtQixFQUFFQyxHQUFhLEVBQUVDLElBQXNCLEVBQVE7SUFDMUUsSUFBSUMsZUFBQyxDQUFDQyxLQUFLLENBQUNKLEdBQUcsQ0FBQ0ssV0FBVyxDQUFDaEIsSUFBSSxDQUFDLEtBQUssS0FBSyxFQUFFO01BQzNDLE9BQU9hLElBQUksQ0FBQ2QsWUFBWSxDQUFDWSxHQUFHLENBQUNLLFdBQVcsQ0FBQ2hCLElBQUksQ0FBQyxDQUFDO0lBQ2pEO0lBRUFZLEdBQUcsQ0FBQ0ssTUFBTSxDQUFDQyxzQkFBVyxDQUFDQyxZQUFZLENBQUM7SUFDcEMsT0FBT04sSUFBSSxDQUFDO01BQ1ZPLE9BQU8sRUFBRUMsb0JBQVMsQ0FBQ0M7SUFDckIsQ0FBQyxDQUFDO0VBQ0osQ0FB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