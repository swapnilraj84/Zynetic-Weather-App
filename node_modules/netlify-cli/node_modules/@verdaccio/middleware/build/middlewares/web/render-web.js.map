{"version":3,"file":"render-web.js","names":["debug","buildDebug","sendFileCallback","next","err","status","HTTP_STATUS","NOT_FOUND","renderWebMiddleware","config","tokenMiddleware","pluginOptions","staticPath","manifest","manifestFiles","router","express","Router","use","setSecurityWebHeaders","logoURI","web","logo","isURLhasValidProtocol","path","posix","join","basename","get","req","res","sendFile","resolve","filename","params","file","isHTTPProtocol","absoluteLocalFile","fs","existsSync","accessSync","constants","R_OK","_req","undefined","renderHTML"],"sources":["../../../src/middlewares/web/render-web.ts"],"sourcesContent":["import buildDebug from 'debug';\nimport express from 'express';\nimport fs from 'fs';\nimport path from 'path';\n\nimport { HTTP_STATUS } from '@verdaccio/core';\nimport { isURLhasValidProtocol } from '@verdaccio/url';\n\nimport { setSecurityWebHeaders } from './security';\nimport renderHTML, { isHTTPProtocol } from './utils/renderHTML';\n\nconst debug = buildDebug('verdaccio:web:render');\n\nconst sendFileCallback = (next) => (err) => {\n  if (!err) {\n    return;\n  }\n  if (err.status === HTTP_STATUS.NOT_FOUND) {\n    next();\n  } else {\n    next(err);\n  }\n};\n\nexport function renderWebMiddleware(config, tokenMiddleware, pluginOptions) {\n  const { staticPath, manifest, manifestFiles } = pluginOptions;\n  debug('static path %o', staticPath);\n\n  /* eslint new-cap:off */\n  const router = express.Router();\n  if (typeof tokenMiddleware === 'function') {\n    router.use(tokenMiddleware);\n  }\n  router.use(setSecurityWebHeaders);\n\n  // Logo\n  let logoURI = config?.web?.logo ?? '';\n  if (logoURI && !isURLhasValidProtocol(logoURI)) {\n    // URI related to a local file\n\n    // Note: `path.join` will break on Windows, because it transforms `/` to `\\`\n    // Use POSIX version `path.posix.join` instead.\n    logoURI = path.posix.join('/-/static/', path.basename(logoURI));\n    router.get(logoURI, function (req, res, next) {\n      res.sendFile(path.resolve(config.web.logo), sendFileCallback(next));\n      debug('render static');\n    });\n  }\n\n  // Static\n  router.get('/-/static/*', function (req, res, next) {\n    const filename = req.params[0];\n    const file = `${staticPath}/${filename}`;\n    debug('render static file %o', file);\n    res.sendFile(file, sendFileCallback(next));\n  });\n\n  // logo\n  if (config?.web?.logo && !isHTTPProtocol(config?.web?.logo)) {\n    // URI related to a local file\n    const absoluteLocalFile = path.posix.resolve(config.web.logo);\n    debug('serve local logo %s', absoluteLocalFile);\n    try {\n      // TODO: remove existsSync by async alternative\n      if (\n        fs.existsSync(absoluteLocalFile) &&\n        typeof fs.accessSync(absoluteLocalFile, fs.constants.R_OK) === 'undefined'\n      ) {\n        // Note: `path.join` will break on Windows, because it transforms `/` to `\\`\n        // Use POSIX version `path.posix.join` instead.\n        config.web.logo = path.posix.join('/-/static/', path.basename(config.web.logo));\n        router.get(config.web.logo, function (_req, res, next) {\n          // @ts-ignore\n          debug('serve custom logo  web:%s - local:%s', config.web.logo, absoluteLocalFile);\n          res.sendFile(absoluteLocalFile, sendFileCallback(next));\n        });\n        debug('enabled custom logo %s', config.web.logo);\n      } else {\n        config.web.logo = undefined;\n        debug(`web logo is wrong, path ${absoluteLocalFile} does not exist or is not readable`);\n      }\n    } catch {\n      config.web.logo = undefined;\n      debug(`web logo is wrong, path ${absoluteLocalFile} does not exist or is not readable`);\n    }\n  }\n\n  router.get('/-/web/:section/*', function (req, res) {\n    renderHTML(config, manifest, manifestFiles, req, res);\n    debug('render html section');\n  });\n\n  router.get('/', function (req, res) {\n    renderHTML(config, manifest, manifestFiles, req, res);\n    debug('render root');\n  });\n\n  return router;\n}\n"],"mappings":"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"}