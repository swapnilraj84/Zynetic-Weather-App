{"version":3,"file":"renderHTML.js","names":["DEFAULT_LANGUAGE","cache","LRU","max","ttl","debug","buildDebug","defaultManifestFiles","js","ico","isHTTPProtocol","uri","test","resolveLogo","config","req","isLocalFile","web","logo","getPublicUrl","url_prefix","path","basename","renderHTML","manifest","manifestFiles","res","base","URL","pathname","language","i18n","needHtmlCache","undefined","includes","html_cache","darkMode","title","WEB_TITLE","login","hasLogin","scope","logoURI","pkgManagers","version","flags","experiments","primaryColor","validatePrimaryColor","primary_color","scriptsBodyAfter","metaScripts","scriptsbodyBefore","showInfo","showSettings","showThemeSwitch","showFooter","showSearch","showDownloadTarball","Object","assign","bodyBefore","options","webPage","get","renderTemplate","set","error","Error","stack","setHeader","HEADERS","TEXT_HTML","send"],"sources":["../../../../src/middlewares/web/utils/renderHTML.ts"],"sourcesContent":["import buildDebug from 'debug';\nimport LRU from 'lru-cache';\nimport path from 'path';\nimport { URL } from 'url';\n\nimport { WEB_TITLE } from '@verdaccio/config';\nimport { HEADERS } from '@verdaccio/core';\nimport { TemplateUIOptions } from '@verdaccio/types';\nimport { getPublicUrl } from '@verdaccio/url';\n\nimport renderTemplate from './template';\nimport { hasLogin, validatePrimaryColor } from './web-utils';\n\nconst DEFAULT_LANGUAGE = 'es-US';\nconst cache = new LRU({ max: 500, ttl: 1000 * 60 * 60 });\n\nconst debug = buildDebug('verdaccio:web:render');\n\nconst defaultManifestFiles = {\n  js: ['runtime.js', 'vendors.js', 'main.js'],\n  ico: 'favicon.ico',\n};\n\n/**\n * Check if URI is starting with \"http://\", \"https://\" or \"//\"\n * @param {string} uri\n */\nexport function isHTTPProtocol(uri: string): boolean {\n  return /^(https?:)?\\/\\//.test(uri);\n}\n\nexport function resolveLogo(config, req) {\n  const isLocalFile = config?.web?.logo && !isHTTPProtocol(config?.web?.logo);\n\n  if (isLocalFile) {\n    return `${getPublicUrl(config?.url_prefix, req)}-/static/${path.basename(config?.web?.logo)}`;\n  } else if (isHTTPProtocol(config?.web?.logo)) {\n    return config?.web?.logo;\n  } else {\n    return '';\n  }\n}\n\nexport default function renderHTML(config, manifest, manifestFiles, req, res) {\n  const { url_prefix } = config;\n  const base = getPublicUrl(config?.url_prefix, req);\n  const basename = new URL(base).pathname;\n  const language = config?.i18n?.web ?? DEFAULT_LANGUAGE;\n  const needHtmlCache = [undefined, null].includes(config?.web?.html_cache)\n    ? true\n    : config.web.html_cache;\n  const darkMode = config?.web?.darkMode ?? false;\n  const title = config?.web?.title ?? WEB_TITLE;\n  const login = hasLogin(config);\n  const scope = config?.web?.scope ?? '';\n  const logoURI = resolveLogo(config, req);\n  const pkgManagers = config?.web?.pkgManagers ?? ['yarn', 'pnpm', 'npm'];\n  const version = config?.web?.version;\n  const flags = {\n    ...config.flags,\n    // legacy from 5.x\n    ...config.experiments,\n  };\n  const primaryColor = validatePrimaryColor(config?.web?.primary_color) ?? '#4b5e40';\n  const {\n    scriptsBodyAfter,\n    metaScripts,\n    scriptsbodyBefore,\n    showInfo,\n    showSettings,\n    showThemeSwitch,\n    showFooter,\n    showSearch,\n    showDownloadTarball,\n  } = Object.assign(\n    {},\n    {\n      scriptsBodyAfter: [],\n      bodyBefore: [],\n      metaScripts: [],\n    },\n    config?.web\n  );\n  const options: TemplateUIOptions = {\n    showInfo,\n    showSettings,\n    showThemeSwitch,\n    showFooter,\n    showSearch,\n    showDownloadTarball,\n    darkMode,\n    url_prefix,\n    basename,\n    base,\n    primaryColor,\n    version,\n    logoURI,\n    flags,\n    login,\n    pkgManagers,\n    title,\n    scope,\n    language,\n  };\n\n  let webPage;\n\n  try {\n    webPage = cache.get('template');\n    if (!webPage) {\n      webPage = renderTemplate(\n        {\n          manifest: manifestFiles ?? defaultManifestFiles,\n          options,\n          scriptsBodyAfter,\n          metaScripts,\n          scriptsbodyBefore,\n        },\n        manifest\n      );\n      if (needHtmlCache) {\n        cache.set('template', webPage);\n        debug('set template cache');\n      }\n    } else {\n      debug('reuse template cache');\n    }\n  } catch (error: any) {\n    throw new Error(`theme could not be load, stack ${error.stack}`);\n  }\n  res.setHeader('Content-Type', HEADERS.TEXT_HTML);\n  res.send(webPage);\n  debug('web rendered');\n}\n"],"mappings":";;;;;;;;AAAA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AAA6D;AAE7D,MAAMA,gBAAgB,GAAG,OAAO;AAChC,MAAMC,KAAK,GAAG,IAAIC,iBAAG,CAAC;EAAEC,GAAG,EAAE,GAAG;EAAEC,GAAG,EAAE,IAAI,GAAG,EAAE,GAAG;AAAG,CAAC,CAAC;AAExD,MAAMC,KAAK,GAAG,IAAAC,cAAU,EAAC,sBAAsB,CAAC;AAEhD,MAAMC,oBAAoB,GAAG;EAC3BC,EAAE,EAAE,CAAC,YAAY,EAAE,YAAY,EAAE,SAAS,CAAC;EAC3CC,GAAG,EAAE;AACP,CAAC;;AAED;AACA;AACA;AACA;AACO,SAASC,cAAc,CAACC,GAAW,EAAW;EACnD,OAAO,iBAAiB,CAACC,IAAI,CAACD,GAAG,CAAC;AACpC;AAEO,SAASE,WAAW,CAACC,MAAM,EAAEC,GAAG,EAAE;EAAA;EACvC,MAAMC,WAAW,GAAG,CAAAF,MAAM,aAANA,MAAM,sCAANA,MAAM,CAAEG,GAAG,gDAAX,YAAaC,IAAI,KAAI,CAACR,cAAc,CAACI,MAAM,aAANA,MAAM,uCAANA,MAAM,CAAEG,GAAG,iDAAX,aAAaC,IAAI,CAAC;EAE3E,IAAIF,WAAW,EAAE;IAAA;IACf,OAAQ,GAAE,IAAAG,kBAAY,EAACL,MAAM,aAANA,MAAM,uBAANA,MAAM,CAAEM,UAAU,EAAEL,GAAG,CAAE,YAAWM,aAAI,CAACC,QAAQ,CAACR,MAAM,aAANA,MAAM,uCAANA,MAAM,CAAEG,GAAG,iDAAX,aAAaC,IAAI,CAAE,EAAC;EAC/F,CAAC,MAAM,IAAIR,cAAc,CAACI,MAAM,aAANA,MAAM,uCAANA,MAAM,CAAEG,GAAG,iDAAX,aAAaC,IAAI,CAAC,EAAE;IAAA;IAC5C,OAAOJ,MAAM,aAANA,MAAM,uCAANA,MAAM,CAAEG,GAAG,iDAAX,aAAaC,IAAI;EAC1B,CAAC,MAAM;IACL,OAAO,EAAE;EACX;AACF;AAEe,SAASK,UAAU,CAACT,MAAM,EAAEU,QAAQ,EAAEC,aAAa,EAAEV,GAAG,EAAEW,GAAG,EAAE;EAAA;EAC5E,MAAM;IAAEN;EAAW,CAAC,GAAGN,MAAM;EAC7B,MAAMa,IAAI,GAAG,IAAAR,kBAAY,EAACL,MAAM,aAANA,MAAM,uBAANA,MAAM,CAAEM,UAAU,EAAEL,GAAG,CAAC;EAClD,MAAMO,QAAQ,GAAG,IAAIM,QAAG,CAACD,IAAI,CAAC,CAACE,QAAQ;EACvC,MAAMC,QAAQ,uBAAGhB,MAAM,aAANA,MAAM,uCAANA,MAAM,CAAEiB,IAAI,iDAAZ,aAAcd,GAAG,+DAAIjB,gBAAgB;EACtD,MAAMgC,aAAa,GAAG,CAACC,SAAS,EAAE,IAAI,CAAC,CAACC,QAAQ,CAACpB,MAAM,aAANA,MAAM,uCAANA,MAAM,CAAEG,GAAG,iDAAX,aAAakB,UAAU,CAAC,GACrE,IAAI,GACJrB,MAAM,CAACG,GAAG,CAACkB,UAAU;EACzB,MAAMC,QAAQ,2BAAGtB,MAAM,aAANA,MAAM,uCAANA,MAAM,CAAEG,GAAG,iDAAX,aAAamB,QAAQ,uEAAI,KAAK;EAC/C,MAAMC,KAAK,wBAAGvB,MAAM,aAANA,MAAM,uCAANA,MAAM,CAAEG,GAAG,iDAAX,aAAaoB,KAAK,iEAAIC,iBAAS;EAC7C,MAAMC,KAAK,GAAG,IAAAC,kBAAQ,EAAC1B,MAAM,CAAC;EAC9B,MAAM2B,KAAK,wBAAG3B,MAAM,aAANA,MAAM,uCAANA,MAAM,CAAEG,GAAG,iDAAX,aAAawB,KAAK,iEAAI,EAAE;EACtC,MAAMC,OAAO,GAAG7B,WAAW,CAACC,MAAM,EAAEC,GAAG,CAAC;EACxC,MAAM4B,WAAW,4BAAG7B,MAAM,aAANA,MAAM,wCAANA,MAAM,CAAEG,GAAG,kDAAX,cAAa0B,WAAW,yEAAI,CAAC,MAAM,EAAE,MAAM,EAAE,KAAK,CAAC;EACvE,MAAMC,OAAO,GAAG9B,MAAM,aAANA,MAAM,wCAANA,MAAM,CAAEG,GAAG,kDAAX,cAAa2B,OAAO;EACpC,MAAMC,KAAK,GAAG;IACZ,GAAG/B,MAAM,CAAC+B,KAAK;IACf;IACA,GAAG/B,MAAM,CAACgC;EACZ,CAAC;EACD,MAAMC,YAAY,4BAAG,IAAAC,8BAAoB,EAAClC,MAAM,aAANA,MAAM,wCAANA,MAAM,CAAEG,GAAG,kDAAX,cAAagC,aAAa,CAAC,yEAAI,SAAS;EAClF,MAAM;IACJC,gBAAgB;IAChBC,WAAW;IACXC,iBAAiB;IACjBC,QAAQ;IACRC,YAAY;IACZC,eAAe;IACfC,UAAU;IACVC,UAAU;IACVC;EACF,CAAC,GAAGC,MAAM,CAACC,MAAM,CACf,CAAC,CAAC,EACF;IACEV,gBAAgB,EAAE,EAAE;IACpBW,UAAU,EAAE,EAAE;IACdV,WAAW,EAAE;EACf,CAAC,EACDrC,MAAM,aAANA,MAAM,uBAANA,MAAM,CAAEG,GAAG,CACZ;EACD,MAAM6C,OAA0B,GAAG;IACjCT,QAAQ;IACRC,YAAY;IACZC,eAAe;IACfC,UAAU;IACVC,UAAU;IACVC,mBAAmB;IACnBtB,QAAQ;IACRhB,UAAU;IACVE,QAAQ;IACRK,IAAI;IACJoB,YAAY;IACZH,OAAO;IACPF,OAAO;IACPG,KAAK;IACLN,KAAK;IACLI,WAAW;IACXN,KAAK;IACLI,KAAK;IACLX;EACF,CAAC;EAED,IAAIiC,OAAO;EAEX,IAAI;IACFA,OAAO,GAAG9D,KAAK,CAAC+D,GAAG,CAAC,UAAU,CAAC;IAC/B,IAAI,CAACD,OAAO,EAAE;MACZA,OAAO,GAAG,IAAAE,iBAAc,EACtB;QACEzC,QAAQ,EAAEC,aAAa,aAAbA,aAAa,cAAbA,aAAa,GAAIlB,oBAAoB;QAC/CuD,OAAO;QACPZ,gBAAgB;QAChBC,WAAW;QACXC;MACF,CAAC,EACD5B,QAAQ,CACT;MACD,IAAIQ,aAAa,EAAE;QACjB/B,KAAK,CAACiE,GAAG,CAAC,UAAU,EAAEH,OAAO,CAAC;QAC9B1D,KAAK,CAAC,oBAAoB,CAAC;MAC7B;IACF,CAAC,MAAM;MACLA,KAAK,CAAC,sBAAsB,CAAC;IAC/B;EACF,CAAC,CAAC,OAAO8D,KAAU,EAAE;IACnB,MAAM,IAAIC,KAAK,CAAE,kCAAiCD,KAAK,CAACE,KAAM,EAAC,CAAC;EAClE;EACA3C,GAAG,CAAC4C,SAAS,CAAC,cAAc,EAAEC,aAAO,CAACC,SAAS,CAAC;EAChD9C,GAAG,CAAC+C,IAAI,CAACV,OAAO,CAAC;EACjB1D,KAAK,CAAC,cAAc,CAAC;AACvB"}